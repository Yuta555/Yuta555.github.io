<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>NYC Crime</title>
		<script src="https://d3js.org/d3.v6.js"></script>
        <script src="https://d3js.org/d3-array.v2.min.js"></script>
        <script src="https://d3js.org/d3-geo.v2.min.js"></script>
	</head>
	<body>
        <h2>NYC Crime Map</h2>
        <div align="center" style="position:relative;top:10px">
            <button id="reset">Reset</button>
        </div> 
        <script>
        // canvas setting
        const SvgWidth = 1200
        const SvgHeight = 600
        
        // Map
        const MapWidth = 100
        const MapHeight = 50
        const MapMargin = {"left": -220, "top": -35}
        const LegendMargin = {"left": 0, "top": 10}
        const LegendSize = {"width": 20, "height": 100}

        // Pie
        const PieWidth = 100
        const PieHeight = 100
        const PieMargin = {"left": 650, "top": 100}
        const InnerRadius = 35
        const OutterRadius = 70

        // bar plot
        const BarWidth = 150
        const BarHeight =100
        const BarMargin1 = {"left": 500, "top": 250}
        const BarMargin2 = {"left": 700, "top": 250}
        const BarMargin3 = {"left": 900, "top": 250}
       
        const duration = 24;

        // define global indicator
        var PRECINCT = 'all';
        var CRIME_TYPE = 'all';

        // initialization for all sub-graphs

        // nyc map
        const projection = d3.geoMercator()// mercator makes it easy to center on specific lat/long
                .scale(43000)
                .center([-73.94, 40.70]); // long, lat of NYC

        const pathGenerator = d3.geoPath()
            .projection(projection);
        
        var centered;
        var svg = d3.select("body").append("svg")
                    .attr("width", SvgWidth)
                    .attr("height", SvgHeight)
        
        var background = svg.append("rect")
                                .attr("class", "background")
                                .attr("width", SvgWidth)
                                .attr("height", SvgHeight)
                                .style('fill', 'white')
                                // .on("click", function(d){
                                //     reset_map;
                                //     reset_pie_all;
                                // });

        var nycMap = svg.append('g')
                          .attr('width', MapWidth)
                          .attr('height', MapHeight)
                          .attr("transform", "translate(" + MapMargin.left+ "," + MapMargin.top + ")");
        
        // legend for heatmap
        var legend = svg.append('g')
            .attr("transform", "translate(" + LegendMargin.left + "," + (LegendMargin.top) + ")")
            
        legend.append("rect")
            .attr("width", LegendSize.width)
            .attr("height", LegendSize.height)
            .style("fill", "url(#linear-gradient)");
        
        // create tooltip
        var tooltip = d3.select("body")
            .append("div")
            .style("position", "absolute")
            .style("background-color", "#CCE7F5")
            .style("padding", "4px")
            .style("z-index", "2")
            .style("visibility", "hidden")
            .text("a simple tooltip");

        var colorAxis = legend.append('g').attr("transform", "translate(0," + LegendSize.height + ")");
        
        // pie chart
        var pieChart = svg.append('g')
                          .attr('width', PieWidth)
                          .attr('height', PieHeight)
                          .attr("transform", "translate(" + PieMargin.left+ "," + PieMargin.top + ")");
        var arc = d3.arc()
                .innerRadius(InnerRadius)
                .outerRadius(OutterRadius);

        var pieColor = d3.scaleOrdinal(['#4daf4a','#377eb8','#ff7f00','#984ea3','#6C182A']);
        const CrimeColorMap = {'ASSAULT': '#4daf4a', 
                                'THEFT': '#377eb8',
                                'ROBBERY': '#ff7f00',
                                'SEX CRIMES': '#984ea3',
                                'MURDER': '#6C182A'}
        

        d3.json('police_precincts.geo.json').then(function(geo_data){
            
            // console.log(geo_data)
            d3.json('https://raw.githubusercontent.com/oliverliuoo/nyc-crime-covid19/main/d3/source/data/cnt_group_by_precinct.json').then(function(data){
                // console.log(data)
                
                // var data_by_precinct = d3.group(data, d => d.arrest_precinct);
                // console.log(data_by_precinct)
                var sum_cnt_list = [];
                // calculae sum values for each precinct
                for (key in data){
                    sum_cnt_list.push(data[key]['sum']);
                }
                maxCnt = d3.max(sum_cnt_list);
                minCnt = d3.min(sum_cnt_list);

                // console.log(minCnt) 
                // console.log(maxCnt)            

                nycMap.selectAll('path')
                .data(geo_data.features)
                .enter().append('path')
                    .attr("id", function(d){return d.properties.Precinct.toString()})
                    .attr("tot_cnt", function(d){return data[d.properties.Precinct.toString()]['sum']})
                    .attr("stroke","grey")//设置边线颜色
                    .attr("stroke-width",0.75)//设置边线宽度
                    .style('fill', '#E13C19')
                    .style('fill-opacity', function(d){
                        if (data.hasOwnProperty(d.properties.Precinct.toString())){
                            return (data[d.properties.Precinct.toString()]['sum'] - minCnt) / (maxCnt - minCnt);
                        }
                        return 0;
                    })
                    // .style('fill', d => color(crime_cn4t.get(d.id.toString())))
                    .attr('d', pathGenerator)
                    .on('mouseover', function (d, i) {
                            //console.log(this);
                            // edit tooltip
                            console.log(d);
                            if (CRIME_TYPE == "all"){
                                crime_cnt = data[this.id]['sum'];
                            }
                            else{
                                crime_cnt = data[this.id][CRIME_TYPE];
                            }
                            tooltip.style("visibility", "visible")
                                   .text("precinct-ID: " + this.id + "\n" + 
                                   "  crime count: " + crime_cnt + "  crime_type: " + CRIME_TYPE);

                            d3.select(this).transition()
                                    .attr('stroke', 'black')
                                    .attr("stroke-width", 1);
                            update_pie(this.id);
                            if (CRIME_TYPE == 'all'){
                                update_age(1, this.id);
                                update_race(1, this.id);
                                update_sex(1, this.id);
                            }
                            else{
                                key = [CRIME_TYPE, this.id]
                                update_age(3, key);
                                update_race(3, key);
                                update_sex(3, key);
                            }
                                            })
                    .on("mousemove", function(){
                            return tooltip.style("top", (event.pageY-20)+"px")
                                          .style("left",(event.pageX+20)+"px");})
                    .on('mouseout', function (d, i) {
                            tooltip.style("visibility", "hidden");
                            d3.select(this).transition()
                                    .attr('stroke', 'grey')
                                    .attr("stroke-width",0.75);
                            reset_pie_partial();
                            if (CRIME_TYPE == 'ALL'){
                                reset_age();
                                reset_sex();
                                reset_race();
                            }
                            else{
                                update_age(2, CRIME_TYPE);
                                update_race(2, CRIME_TYPE);
                                update_sex(2, CRIME_TYPE);
                            }
                                        })
                    //.on('click', click_map);

            });    
        });
        

        function zoomed(event) {
            const {transform} = event;
            nycMap.attr("transform", transform);
            nycMap.attr("stroke-width", 1 / transform.k);
            }
        
        
        function update_map(crime_type){
                d3.json('police_precincts.geo.json').then(function(geo_data){
                    // console.log(geo_data)
                    d3.json('https://raw.githubusercontent.com/oliverliuoo/nyc-crime-covid19/main/d3/source/data/cnt_group_by_precinct.json').then(function(data){
                        var sum_cnt_list = [];
                        // calculae sum values for each precinct
                        for (key in data){
                            sum_cnt_list.push(data[key][crime_type]);
                        }
                        maxCnt = d3.max(sum_cnt_list);
                        minCnt = d3.min(sum_cnt_list);

                        nycMap.selectAll('path')
                            .style('fill', CrimeColorMap[crime_type])
                            .style('fill-opacity', function(d){
                                if (data.hasOwnProperty(d.properties.Precinct.toString())){
                                    return (data[d.properties.Precinct.toString()][crime_type] - minCnt) / (maxCnt - minCnt);
                                }
                                return 0;
                            })

                    });    
            });
        }

        function reset_map(){
            d3.json('police_precincts.geo.json').then(function(geo_data){
                    // console.log(geo_data)
                    d3.json('https://raw.githubusercontent.com/oliverliuoo/nyc-crime-covid19/main/d3/source/data//cnt_group_by_precinct.json').then(function(data){
                        var sum_cnt_list = [];
                        // calculae sum values for each precinct
                        for (key in data){
                            sum_cnt_list.push(data[key]['sum']);
                        }
                        maxCnt = d3.max(sum_cnt_list);
                        minCnt = d3.min(sum_cnt_list);

                        nycMap.selectAll('path')
                            .style('fill', '#E13C19')
                            .style('fill-opacity', function(d){
                                if (data.hasOwnProperty(d.properties.Precinct.toString())){
                                    return (data[d.properties.Precinct.toString()]['sum'] - minCnt) / (maxCnt - minCnt);
                                }
                                return 0;
                            })

                    });    
            });
        }


        function highlightArc(crime_type){
            pieChart.selectAll('.arc')
                    .select('path')
                    .attr('fill-opacity', function(d){
                        if (d.data.type == crime_type){
                            return 1;
                        }
                        return 0.35;
                    })
        }

        function calcTranslate(data, move = 5) {
            const moveAngle = data.startAngle + ((data.endAngle - data.startAngle) / 2);
            return `translate(${- move * Math.cos(moveAngle + Math.PI / 2)}, ${- move * Math.sin(moveAngle + Math.PI / 2)})`;
        }

        function click_map(d) {
            var x, y, k;
            console.log(d);
            if (d && centered !== d) {
                var centroid = pathGenerator.centroid(d);
                console.log(centroid)
                x = centroid[0];
                y = centroid[1];
                k = 4;
                centered = d;
            } else {
                x = MapWidth / 2;
                y = MapHeight / 2;
                k = 1;
                centered = null;
            }

            nycMap.selectAll("path")
                .classed("active", centered && function(d) { return d === centered; });

            nycMap.transition()
                .duration(750)
                .attr("transform", "translate(" + MapWidth / 2 + "," + MapHeight / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
                .style("stroke-width", 1.5 / k + "px");
         }
        </script>
    </body>
</html>
