<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>NYC Crime</title>
		<script src="https://d3js.org/d3.v6.js"></script>
        <script src="https://d3js.org/d3-array.v2.min.js"></script>
        <script src="https://d3js.org/d3-geo.v2.min.js"></script>
	</head>
	<body>
        <h2>NYC Crime Map</h2>
        <div align="center" style="position:relative;top:10px">
            <button id="reset">Reset</button>
        </div> 
        <script>
        // canvas setting
        const SvgWidth = 1200
        const SvgHeight = 600
        
        // Map
        const MapWidth = 100
        const MapHeight = 50
        const MapMargin = {"left": -220, "top": -35}
        const LegendMargin = {"left": 0, "top": 10}
        const LegendSize = {"width": 20, "height": 100}
       
        const duration = 24;

        // define global indicator
        var PRECINCT = 'all';
        var CRIME_TYPE = 'all';

        // initialization for all sub-graphs

        // nyc map
        const projection = d3.geoMercator()// mercator makes it easy to center on specific lat/long
                .scale(43000)
                .center([-73.94, 40.70]); // long, lat of NYC

        const pathGenerator = d3.geoPath()
            .projection(projection);
        
        var centered;
        var svg = d3.select("body").append("svg")
                    .attr("width", SvgWidth)
                    .attr("height", SvgHeight)
        
        var background = svg.append("rect")
                                .attr("class", "background")
                                .attr("width", SvgWidth)
                                .attr("height", SvgHeight)
                                .style('fill', 'white')

        var nycMap = svg.append('g')
                          .attr('width', MapWidth)
                          .attr('height', MapHeight)
                          .attr("transform", "translate(" + MapMargin.left+ "," + MapMargin.top + ")");
        
        // legend for heatmap
        var legend = svg.append('g')
            .attr("transform", "translate(" + LegendMargin.left + "," + (LegendMargin.top) + ")")
            
        legend.append("rect")
            .attr("width", LegendSize.width)
            .attr("height", LegendSize.height)
            .style("fill", "black");
        
        // create tooltip
        var tooltip = d3.select("body")
            .append("div")
            .style("position", "absolute")
            .style("background-color", "#CCE7F5")
            .style("padding", "4px")
            .style("z-index", "2")
            .style("visibility", "hidden")
            .text("a simple tooltip");

        var colorAxis = legend.append('g').attr("transform", "translate(0," + LegendSize.height + ")");
        
        const CrimeColorMap = {'ASSAULT': '#4daf4a', 
                                'THEFT': '#377eb8',
                                'ROBBERY': '#ff7f00',
                                'SEX CRIMES': '#984ea3',
                                'MURDER': '#6C182A'}
        

        d3.json('police_precincts.geo.json').then(function(geo_data){
		
            // concatenate csv with json
            d3.csv('num_precinct.csv').then(function(data){
                // console.log(data)
		for (var i = 0; i < data.length; i++) {
		    var prec = data[i].addr_pct_cd;
		    var num_crime = parseFloat(data[i].freq);
		    for (var j = 0; j < geo_data.features.length; j++) {
			var jsonPrec = geo_data.features[j].properties.Precinct;
			if (prec == jsonPrec) {
			    geo_data.features[j].properties.num_crime = num_crime;
			    break;
			}
		    }
		}
                
                // var data_by_precinct = d3.group(data, d => d.arrest_precinct);
                // console.log(data_by_precinct)
                var freq_list = [];
                // calculate sum values for each precinct
                for (var i=0; i<data.length; i++){
			freq_list.push(data[i].freq);
                }
                maxFreq = d3.max(freq_list);
                minFreq = d3.min(freq_list);

                // console.log(minCnt) 
                // console.log(maxCnt)            

                nycMap.selectAll('path')
                .data(geo_data.features)
                .enter().append('path')
                    .attr("id", function(d){return d.properties.Precinct.toString()})
                    .attr("tot_cnt", function(d){return d.properties.num_crime.toString()})
                    .attr("stroke","grey")
                    .attr("stroke-width",0.75)
                    .style('fill', '#E13C19')
                    .style('fill-opacity', function(d){
                        if (data.hasOwnProperty(d.properties.Precinct.toString())){
                            return (d.properties.num_crime.toString() - minFreq) / (maxFreq - minFreq);
                        }
                        return 0;
                    })
                    .attr('d', pathGenerator)
                    .on('mouseover', function (d, i) {
                            console.log(d);
                            if (CRIME_TYPE == "all"){
                                crime_cnt = d.properties.mum_crime;
                            }
                            else{
                                crime_cnt = data[this.id][CRIME_TYPE];
                            }
                            tooltip.style("visibility", "visible")
                                   .text("precinct-ID: " + this.id + "\n" + 
                                   "  crime count: " + crime_cnt + "  crime_type: " + CRIME_TYPE);

                            d3.select(this).transition()
                                    .attr('stroke', 'black')
                                    .attr("stroke-width", 1);
		    })
                    .on("mousemove", function(){
                            return tooltip.style("top", (event.pageY-20)+"px")
                                          .style("left",(event.pageX+20)+"px");})
                    .on('mouseout', function (d, i) {
                            tooltip.style("visibility", "hidden");
                            d3.select(this).transition()
                                    .attr('stroke', 'grey')
                                    .attr("stroke-width",0.75);   
                    })

            });    
        });
        

        function zoomed(event) {
            const {transform} = event;
            nycMap.attr("transform", transform);
            nycMap.attr("stroke-width", 1 / transform.k);
            }
        
        
        function update_map(crime_type){
                d3.json('police_precincts.geo.json').then(function(geo_data){
                    // console.log(geo_data)
                    d3.json('https://raw.githubusercontent.com/oliverliuoo/nyc-crime-covid19/main/d3/source/data/cnt_group_by_precinct.json').then(function(data){
                        var sum_cnt_list = [];
                        // calculae sum values for each precinct
                        for (key in data){
                            sum_cnt_list.push(data[key][crime_type]);
                        }
                        maxCnt = d3.max(sum_cnt_list);
                        minCnt = d3.min(sum_cnt_list);

                        nycMap.selectAll('path')
                            .style('fill', CrimeColorMap[crime_type])
                            .style('fill-opacity', function(d){
                                if (data.hasOwnProperty(d.properties.Precinct.toString())){
                                    return (data[d.properties.Precinct.toString()][crime_type] - minCnt) / (maxCnt - minCnt);
                                }
                                return 0;
                            })

                    });    
            });
        }

        function reset_map(){
            d3.json('police_precincts.geo.json').then(function(geo_data){
                    // console.log(geo_data)
                    d3.json('https://raw.githubusercontent.com/oliverliuoo/nyc-crime-covid19/main/d3/source/data//cnt_group_by_precinct.json').then(function(data){
                        var sum_cnt_list = [];
                        // calculae sum values for each precinct
                        for (key in data){
                            sum_cnt_list.push(data[key]['sum']);
                        }
                        maxCnt = d3.max(sum_cnt_list);
                        minCnt = d3.min(sum_cnt_list);

                        nycMap.selectAll('path')
                            .style('fill', '#E13C19')
                            .style('fill-opacity', function(d){
                                if (data.hasOwnProperty(d.properties.Precinct.toString())){
                                    return (data[d.properties.Precinct.toString()]['sum'] - minCnt) / (maxCnt - minCnt);
                                }
                                return 0;
                            })

                    });    
            });
        }



        function calcTranslate(data, move = 5) {
            const moveAngle = data.startAngle + ((data.endAngle - data.startAngle) / 2);
            return `translate(${- move * Math.cos(moveAngle + Math.PI / 2)}, ${- move * Math.sin(moveAngle + Math.PI / 2)})`;
        }

        function click_map(d) {
            var x, y, k;
            console.log(d);
            if (d && centered !== d) {
                var centroid = pathGenerator.centroid(d);
                console.log(centroid)
                x = centroid[0];
                y = centroid[1];
                k = 4;
                centered = d;
            } else {
                x = MapWidth / 2;
                y = MapHeight / 2;
                k = 1;
                centered = null;
            }

            nycMap.selectAll("path")
                .classed("active", centered && function(d) { return d === centered; });

            nycMap.transition()
                .duration(750)
                .attr("transform", "translate(" + MapWidth / 2 + "," + MapHeight / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
                .style("stroke-width", 1.5 / k + "px");
         }
        </script>
    </body>
</html>
