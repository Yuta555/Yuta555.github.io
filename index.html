<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>NYC Crime</title>
		<script src="https://d3js.org/d3.v6.js"></script>
        <script src="https://d3js.org/d3-array.v2.min.js"></script>
        <script src="https://d3js.org/d3-geo.v2.min.js"></script>
	</head>
	<body>
        <h2>NYC Crime Map</h2>
        <div align="center" style="position:relative;top:10px">
            <button id="reset">Reset</button>
        </div> 
        <script>
        // canvas setting
        const SvgWidth = 1200
        const SvgHeight = 600
        
        // Map
        const MapWidth = 200
        const MapHeight = 100
        const MapMargin = {"left": -220, "top": -35}
        const LegendMargin = {"left": 0, "top": 10}
        const LegendSize = {"width": 20, "height": 100}
	
	// bar plot
        const barWidth = 150
        const barHeight =100
        const barMargin = {"left": 500, "top": 250}

	var xScaleAge = d3.scaleBand().range ([0, barWidth]).padding(0.4);
	var yScaleAge = d3.scaleLinear().range ([barHeight, 0]);
       
        const duration = 24;

        // define global indicator
        var PRECINCT = 'all';
        var crime_type = 'All';

        // initialization for all sub-graphs

        // nyc map
        const projection = d3.geoMercator()// mercator makes it easy to center on specific lat/long
                .scale(43000)
                .center([-73.94, 40.70]); // long, lat of NYC

        const pathGenerator = d3.geoPath()
            .projection(projection);
        
        var centered;
        var svg = d3.select("body").append("svg")
                    .attr("width", SvgWidth)
                    .attr("height", SvgHeight)
        
        var background = svg.append("rect")
                                .attr("class", "background")
                                .attr("width", SvgWidth)
                                .attr("height", SvgHeight)
                                .style('fill', 'white')

        var map = svg.append('g')
                          .attr('width', MapWidth)
                          .attr('height', MapHeight)
                          .attr("transform", "translate(" + MapMargin.left+ "," + MapMargin.top + ")");
        
        // legend for heatmap
        var legend = svg.append('g')
            .attr("transform", "translate(" + LegendMargin.left + "," + (LegendMargin.top) + ")")
            
        legend.append("rect")
            .attr("width", LegendSize.width)
            .attr("height", LegendSize.height)
            .style("fill", "black");
        
        // create tooltip
        var tooltip = d3.select("body")
            .append("div")
            .style("position", "absolute")
            .style("background-color", "#CCE7F5")
            .style("padding", "4px")
            .style("z-index", "2")
            .style("visibility", "hidden")
            .text("a simple tooltip");

        var colorAxis = legend.append('g').attr("transform", "translate(0," + LegendSize.height + ")");
        
        const CrimeColorMap = {'MURDER': '#4daf4a', 
                                'ASSAULT_OFFENCE': '#377eb8',
                                'ROBBERY_THEFT': '#ff7f00',
                                'SEXUAL_CRIME': '#984ea3',
                                'FRAUD': '#6C182A',
			      	'HARRASSMENT': '#6C182A',
			       	'OTHERS': '#6C182A'
			      }
        
	var barChart = svg.append('g')
                          .attr('width', barWidth)
                          .attr('height', barHeight)
                          .attr("transform", "translate(" + barMargin.left+ "," + barMargin.top + ")");
		
	var barColor = d3.scaleOrdinal(['#4daf4a','#377eb8','#ff7f00','#984ea3','#6C182A']);
		
	var reset_button = d3.select("button#reset")
		     .on('click', function(){
			 reset_map();
			 reset_bar();
		     });

		
        d3.json('police_precincts.geo.json').then(function(geo_data){
            // concatenate csv with json
            d3.json('num_crime.json').then(function(data){
                // console.log(data)		  
                
                var freq_list = [];
                // calculate sum values for each precinct
                for (id in data){
                    freq_list.push(data[id]['All']);
                }
                maxFreq = d3.max(freq_list);
                minFreq = d3.min(freq_list);
       

                map.selectAll('path')
			.data(geo_data.features)
			.enter().append('path')
			    .attr("id", function(d){return d.properties.Precinct})
			    .attr("sum_freq", function(d){return data[d.properties.Precinct]['All']})
			    .attr("stroke","grey")
			    .attr("stroke-width",0.75)
			    .style('fill', '#E13C19')
			    .style('fill-opacity', function(d){
				if (data.hasOwnProperty(d.properties.Precinct)){
				    return (data[d.properties.Precinct]['All'] - minFreq) / (maxFreq - minFreq);
				}
				return 0;
			    })
			    .attr('d', pathGenerator)
			    .on('mouseover', function (d) {
				    console.log(d);
				    if (crime_type == "All"){
					crime_freq = data[this.id]['All'];
				    }
				    else{
					crime_freq = data[this.id][crime_type];
				    }
				    tooltip.style("visibility", "visible")
					   .text("precinct-ID: " + this.id + "\n" + 
					   "  crime count: " + crime_freq + "  crime_type: " + crime_type);

				    d3.select(this).transition()
					    .attr('stroke', 'black')
					    .attr("stroke-width", 1);
			    })
			    .on("mousemove", function(){
				    return tooltip.style("top", (event.pageY-20)+"px")
						  .style("left",(event.pageX+20)+"px");})
			    .on('mouseout', function (d, i) {
				    tooltip.style("visibility", "hidden");
				    d3.select(this).transition()
					    .attr('stroke', 'grey')
					    .attr("stroke-width",0.75);   
			    })

            });    
        });
        

        function zoomed(event) {
            const {transform} = event;
            nycMap.attr("transform", transform);
            nycMap.attr("stroke-width", 1 / transform.k);
            }
        
        
        function update_map(crime_type){
                d3.json('police_precincts.geo.json').then(function(geo_data){
                    // console.log(geo_data)
                    d3.json('num_crime.json').then(function(data){
                        var crime_freq = [];
                        // calculae sum values for each precinct
                        for (id in data){
                            crime_freq.push(data[id][crime_type]);
                        }
                        maxFreq = d3.max(crime_freq);
                        minFreq = d3.min(crime_freq);

                        map.selectAll('path')
                            .style('fill', CrimeColorMap[crime_type])
                            .style('fill-opacity', function(d){
                                if (data.hasOwnProperty(d.properties.Precinct)){
                                    return (data[d.properties.Precinct][crime_type] - minFreq) / (maxFreq - minFreq);
                                }
                                return 0;
                            })

                    });    
            });
        }

        function reset_map(){
            d3.json('police_precincts.geo.json').then(function(geo_data){
                    // console.log(geo_data)
                    d3.json('num_crime.json').then(function(data){
                        var crime_freq = [];
                        // calculae sum values for each precinct
                        for (id in data){
                            crime_freq.push(data[id]['All']);
                        }
                        maxFreq = d3.max(crime_freq);
                        minFreq = d3.min(crime_freq);

                        map.selectAll('path')
                            .style('fill', '#E13C19')
                            .style('fill-opacity', function(d){
                                if (data.hasOwnProperty(d.properties.Precinct)){
                                    return (data[d.properties.Precinct]['All'] - minFreq) / (maxFreq - minFreq);
                                }
                                return 0;
                            })

                    });    
            });
        }
	

	d3.json('num_crime_byType.json').then(function(data){

	    xScaleAge.domain(data.map(function(d) { return d.crime_type; }));
	    yScaleAge.domain([0, d3.max(data, function(d) { return d.freq;})]);

	    // draw axes
	    barChart.append("g")
		.attr("transform", "translate(0," + barHeight + ")")
		.call(d3.axisBottom(xScaleAge))
		.append("text")
		.attr("y", barHeight - 220)
		.attr("x", barWidth / 2)
		.attr("text-anchor", "end")
		.attr("stroke", "black")
		.text("Bar Chart by Crime Type")
		.style("font-size", "12px");

	    barChart.append("g")
		.attr("class", "yAxis")
		.call(d3.axisLeft(yScaleAge).tickFormat(function(d){
		return d;
		}).ticks());

	    barChart.selectAll(".bar")
	      .data(data)
	      .enter().append("rect")
		.attr("class", "bar")
		.attr("x", function(d) { return xScaleAge(d.crime_type); })
		.attr("y", function(d) { return yScaleAge(d.freq); })
		.attr("width", xScaleAge.bandwidth())
		.attr("height", function(d) { return barHeight - yScaleAge(d.freq); })
		.style("fill", function(i, d){ return CrimeColorMap(i)})
		.on('click', function(d){    
		    //console.log(v);
		    crime_type = d.crime_type
		    highlightBar(d.crime_type)
		    update_map(d.crime_type);
		    });

	 });

	function update_age(mode, key){
            d3.json('num_crime_byType.json').then(function(data){
                if (mode == 1){
                    yScaleAge.domain([0, d3.max(data, function(d){ 
                        return d3.sum(Object.values(d.precinct_type_map[key]));
                    })]);
                    BarForAge.select(".yAxis")
                             .call(d3.axisLeft(yScaleAge).tickFormat(function(d){
                                return d;
                             }).ticks());
                    BarForAge.selectAll("rect")
                                .attr("y", function(d) {
                                    var cnt = d3.sum(Object.values(d.precinct_type_map[key]));
                                    return yScaleAge(cnt);
                                })
                                .attr("height", function(d) { 
                                    var cnt = d3.sum(Object.values(d.precinct_type_map[key]));
                                    return BarHeight - yScaleAge(cnt);})
                    }
                if (mode == 2){
                    yScaleAge.domain([0, d3.max(data, function(d){ 
                        return d3.sum(Object.values(d.type_precinct_map[key]));
                    })]);
                    BarForAge.select(".yAxis")
                             .call(d3.axisLeft(yScaleAge).tickFormat(function(d){
                                return d;
                             }).ticks());
                    BarForAge.selectAll("rect")
                                .attr("y", function(d) {
                                    var cnt = d3.sum(Object.values(d.type_precinct_map[key]));
                                    return yScaleAge(cnt);
                                })
                                .attr("height", function(d) { 
                                    var cnt = d3.sum(Object.values(d.type_precinct_map[key]));
                                    return BarHeight - yScaleAge(cnt);})
                }
                if (mode == 3){
                    //console.log('success get mode 3');
                    var type = key[0], precinct = key[1];
                    yScaleAge.domain([0, d3.max(data, function(d){ 
                        return d.type_precinct_map[type][precinct];
                    })]);
                    BarForAge.select(".yAxis")
                             .call(d3.axisLeft(yScaleAge).tickFormat(function(d){
                                return d;
                             }).ticks());
                    BarForAge.selectAll("rect")
                                .attr("y", function(d) {
                                    var cnt = d.type_precinct_map[type][precinct];
                                    return yScaleAge(cnt);
                                })
                                .attr("height", function(d) { 
                                    var cnt = d.type_precinct_map[type][precinct];
                                    return BarHeight - yScaleAge(cnt);})
                }
            })
            
        }
		
	function highlightBar(crime_type){
            barChart.selectAll('.bar')
                    .select('path')
                    .attr('fill-opacity', function(d){
                        if (d.crime_type == crime_type){
                            return 1;
                        }
                        return 0.35;
                    })
        }



        function calcTranslate(data, move = 5) {
            const moveAngle = data.startAngle + ((data.endAngle - data.startAngle) / 2);
            return `translate(${- move * Math.cos(moveAngle + Math.PI / 2)}, ${- move * Math.sin(moveAngle + Math.PI / 2)})`;
        }


        </script>
    </body>
</html>
